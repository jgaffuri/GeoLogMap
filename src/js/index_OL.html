<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS traces</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/openlayers/dist/ol.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        #map {
            height: 100vh;
            width: 100%;
            position: fixed;
            left: 0;
            top: 0;
            overflow: hidden;
        }

        .ol-popup {
            position: absolute;
            background-color: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            min-width: 100px;
            white-space: nowrap;
        }

        .control-container {
            position: absolute;
            top: 65px;
            left: 10px;
            background: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-family: sans-serif;
        }

        .legend-style {
            position: absolute;
            top: 150px;
            left: 10px;
            background-color: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            min-width: 100px;
        }
    </style>
</head>

<body>

    <div id="map" class="map"></div>

    <div class="control-container">
        <form id="layer-switcher">
            <label><input type="radio" name="style" value="default" checked>Traces</label>
            <br>
            <label><input type="radio" name="style" value="byspeed">by speed</label>
            <br>
            <label><input type="radio" name="style" value="bydate">by date</label>
        </form>
    </div>
    <div id="legendSpeed" class="legend-style"></div>
    <div id="legendDate" class="legend-style"></div>

    <div id="popup" class="ol-popup"></div>

    <script>

        //color scales
        const colorScaleSpeed = d3.scaleLinear().domain([0, 0.05, 0.4, 0.75, 0.95, 1]).range(["#4DAF4A", "#4DAF4A", "#377EB8", "#E41A1C", "#FFFF33", "#FFFF33"]);
        const colorScaleDate = d3.scaleLinear().domain([0, 0.5, 1]).range(["#377EB8", "#FFFF33", "#E41A1C"]);

        //legend for date style
        const divLgSpeed = d3.select('#legendSpeed')
            .style('visibility', 'hidden')
        const svgSpeed = divLgSpeed.append('svg')
            .attr('width', 300)
            .attr('height', 55);
        for (let i = 0; i < 300; i++)
            svgSpeed.append('line')
                .attr('x1', i)
                .attr('y1', 15)
                .attr('x2', i)
                .attr('y2', 15 + 20)
                .attr('stroke', colorScaleSpeed(i / 300))
                .attr('stroke-width', 1);
        svgSpeed.append('text').attr("x", 0).attr("y", 10).text("Slow").style("font-family", "Arial").style("font-size", "12").style("font-weight", "bold")
        svgSpeed.append('text').attr("x", 300).attr("y", 10).text("Fast").style("font-family", "Arial").style("font-size", "12").style("font-weight", "bold").style("text-anchor", "end")
        svgSpeed.append('text').attr("x", 0).attr("y", 50).text("Walk").style("font-family", "Arial").style("font-size", "12")
        svgSpeed.append('text').attr("x", 40).attr("y", 50).text("Run").style("font-family", "Arial").style("font-size", "12")
        svgSpeed.append('text').attr("x", 80).attr("y", 50).text("Bike").style("font-family", "Arial").style("font-size", "12")
        svgSpeed.append('text').attr("x", 180).attr("y", 50).text("Drive").style("font-family", "Arial").style("font-size", "12")
        svgSpeed.append('text').attr("x", 300).attr("y", 50).text("Fly").style("font-family", "Arial").style("font-size", "12").style("text-anchor", "end")

        //legend for date style
        const divLgDate = d3.select('#legendDate')
            .style('visibility', 'hidden')
        const svgDate = divLgDate.append('svg')
            .attr('width', 300)
            .attr('height', 55);
        for (let i = 0; i < 300; i++)
            svgDate.append('line')
                .attr('x1', i)
                .attr('y1', 15)
                .attr('x2', i)
                .attr('y2', 15 + 20)
                .attr('stroke', colorScaleDate(i / 300))
                .attr('stroke-width', 1);
        svgDate.append('text').attr("x", 0).attr("y", 10).text("Old").style("font-family", "Arial").style("font-size", "12").style("font-weight", "bold")
        svgDate.append('text').attr("x", 300).attr("y", 10).text("New").style("font-family", "Arial").style("font-size", "12").style("font-weight", "bold").style("text-anchor", "end")
        svgDate.append('text').attr("x", 0).attr("y", 50).text("2009").style("font-family", "Arial").style("font-size", "12")
        svgDate.append('text').attr("x", 100).attr("y", 50).text("2015").style("font-family", "Arial").style("font-size", "12").style("text-anchor", "middle")
        svgDate.append('text').attr("x", 200).attr("y", 50).text("2020").style("font-family", "Arial").style("font-size", "12").style("text-anchor", "middle")
        svgDate.append('text').attr("x", 300).attr("y", 50).text("2024").style("font-family", "Arial").style("font-size", "12").style("text-anchor", "end")

        // highlight style
        const highlightStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: "red",
                width: 5
            })
        })


        //const bckgs = new ol.source.OSM()
        //const bckgs = new ol.source.XYZ({ url: 'http://{a-c}.tile.stamen.com/toner/{z}/{x}/{y}.png' });
        const bckgs = new ol.source.XYZ({ url: 'https://{a-d}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png' })

        //build map
        var map = new ol.Map({
            target: 'map',
            layers: [new ol.layer.Tile({ source: bckgs })],
            view: new ol.View({ center: ol.proj.fromLonLat([5.3698, 43.2965]), zoom: 13 })
        });


        //default style
        const styleDefaultFun = function (f) {
            return new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: "#8400B2",
                    width: 1
                })
            });
        }

        //speed style
        const styleSpeedFun = function (f) {
            const sp = f.get('speed_kmh')
            const t = (sp - 5) / 180
            const color = colorScaleSpeed(t)
            return new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: color,
                    width: 1.5
                })
            });
        }

        //date style
        const styleDateFun = function (f) {
            const ymin = 39.6, ymax = 56
            const timestamp = f.get('start_time')
            const date = new Date(timestamp);
            const years = date.getTime() / 31557600000;
            const t = (years - ymin) / (ymax - ymin)
            const color = colorScaleDate(t)

            return new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: color,
                    width: 1.5
                })
            });
        }



        // popup
        const popupElement = document.getElementById('popup');

        // Variable to store the currently highlighted feature
        let highlightedFeature = null;

        // pointer move event listener
        map.on('pointermove', function (evt) {
            // hide popup element
            popupElement.style.display = 'none';

            // get feature under the mouse cursor
            const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) { return feature; });

            //show popup with feature
            if (feature) {
                popupElement.innerHTML = `Start: ${feature.get('start_time')}<br>End: ${feature.get('end_time')}<br>Length: ${(feature.get('length_m') / 1000).toFixed(1)} km<br>Duration: ${(feature.get('duration_s') / 60).toFixed(1)} min<br>Av speed: ${(feature.get('speed_kmh'))} km/h`;
                popupElement.style.left = `${evt.pixel[0] + 7}px`;
                popupElement.style.top = `${evt.pixel[1] + 7}px`;
                popupElement.style.display = 'block';
            }

            // Reset the style of the previously highlighted feature
            if (highlightedFeature && highlightedFeature !== feature) {
                highlightedFeature.setStyle(null);
                highlightedFeature = null;
            }
            // Highlight the feature under the mouse cursor
            if (feature) {
                feature.setStyle(highlightStyle);
                highlightedFeature = feature;
            }

        });






        getTiledVectorSource = (url) => {

            var vectorSource = new ol.source.Vector();

            //tile cache
            vectorSource.cache = {}
            vectorSource.getCacheData = (z, x, y) => {
                if (!vectorSource.cache[z]) return
                if (!vectorSource.cache[z][x]) return
                return vectorSource.cache[z][x][y]
            }
            vectorSource.insertInCache = (z, x, y, data) => {
                if (!vectorSource.cache[z]) vectorSource.cache[z] = {}
                if (!vectorSource.cache[z][x]) vectorSource.cache[z][x] = {}
                vectorSource.cache[z][x][y] = data
            }


            (async () => {

                const metadata = await (await fetch(url + 'metadata.json')).json()
                //.catch(error => console.error('Error fetching the JSON data:', error));

                //read base metadata
                const r0 = metadata.resolution_0, ts0 = metadata.tile_size * r0,
                    ox = metadata.origin_x, oy = metadata.origin_y,
                    z_min = metadata.z_min, z_max = metadata.z_max

                //transform geojson geometry coordinate from tile CRS to map CRS
                function transformGeoJSONGeometryCoordinates(geometry, tile, ts, r) {
                    function transformCoordinates(coordinates) {
                        if (Array.isArray(coordinates[0])) return coordinates.map(transformCoordinates);
                        else {
                            const x = coordinates[0], y = coordinates[1]
                            return [ox + tile.x * ts + x * r, oy + tile.y * ts + y * r];
                        }
                    }
                    //if (geometry && geometry.coordinates)
                    geometry.coordinates = transformCoordinates(geometry.coordinates);
                }


                vectorSource.update___ = () => {

                    //get zoom level
                    let z = Math.round(map.getView().getZoom())
                    //console.log(z)
                    if (z < z_min) z = z_min; else if (z > z_max) z = z_max

                    //compute tile size and resolution
                    const ddd = Math.pow(2, z)
                    const ts = ts0 / ddd
                    const r = r0 / ddd

                    //clear
                    vectorSource.clear();

                    //get tiles within viewshed
                    var bbox = map.getView().calculateExtent(map.getSize());
                    var tiles = getTiles(bbox, ts);

                    //handle each tile
                    tiles.forEach(tile => {

                        //try to retrieve from cache
                        const features = vectorSource.getCacheData(z, tile.x, tile.y)

                        if (features == "failed" || features == "loading") {
                            //do nothing
                        } else if (features) {
                            //add cached features to layer
                            vectorSource.addFeatures(features);
                        } else {
                            //mark as loading
                            vectorSource.insertInCache(z, tile.x, tile.y, "loading")

                            //launch request
                            fetch(url + z + "/" + tile.x + "/" + tile.y + ".geojson")
                                .then(response => response.json())
                                .then(geojson => {

                                    //apply coordinates transformation to features
                                    geojson.features.forEach(feature => transformGeoJSONGeometryCoordinates(feature.geometry, tile, ts, r));
                                    geojson.features.forEach(feature => feature.id = Math.round(1e15 * Math.random()))

                                    //transform into OL feature
                                    var features = new ol.format.GeoJSON().readFeatures(geojson, { featureProjection: 'EPSG:3857' });

                                    //store into cache
                                    vectorSource.insertInCache(z, tile.x, tile.y, features)

                                    //add features to layer
                                    vectorSource.addFeatures(features);
                                })
                                .catch(error => {
                                    vectorSource.insertInCache(z, tile.x, tile.y, "failed")
                                    //console.error('Error fetching GeoJSON tile:', tile.x, tile.y, error)
                                });
                        }
                    });
                }

                //get tiles intersecting the viewshed
                function getTiles(bbox, ts) {

                    const [xmin, ymin, xmax, ymax] = bbox;

                    const
                        xtmin = Math.floor((xmin - ox) / ts),
                        ytmin = Math.floor((ymin - oy) / ts),
                        xtmax = Math.floor((xmax - ox) / ts),
                        ytmax = Math.floor((ymax - oy) / ts);

                    var tiles = [];
                    for (var xt = xtmin; xt <= xtmax; xt++)
                        for (var yt = ytmin; yt <= ytmax; yt++)
                            tiles.push({ x: xt, y: yt });

                    return tiles;
                }

                //trigger layer refresh on viewshed changes
                map.getView().on('change:center', vectorSource.update___);
                map.getView().on('change:resolution', vectorSource.update___);

                vectorSource.update___();

            })()

            return vectorSource
        }

        const vectorSource = getTiledVectorSource("http://127.0.0.1:5500/tiled/")
        var vectorLayer = new ol.layer.Vector({ source: vectorSource, style: styleDefaultFun });
        map.addLayer(vectorLayer);





        //radio button change event
        document.getElementById('layer-switcher').addEventListener('change', () => {
            //get selected style
            const selectedStyle = document.querySelector('input[name="style"]:checked').value

            //set layer style
            if (selectedStyle == "byspeed") vectorLayer.setStyle(styleSpeedFun)
            else if (selectedStyle == "bydate") vectorLayer.setStyle(styleDateFun)
            else vectorLayer.setStyle(styleDefaultFun)

            //show/hide legends
            divLgSpeed.style('visibility', selectedStyle == "byspeed" ? 'visible' : 'hidden');
            divLgDate.style('visibility', selectedStyle == "bydate" ? 'visible' : 'hidden');

            //update
            vectorSource.update___()
        });


    </script>
</body>

</html>