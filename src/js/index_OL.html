<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS traces</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/openlayers/dist/ol.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="TiledVectorSource.js"></script>

    <style>
        #map {
            height: 100vh;
            width: 100%;
            position: fixed;
            left: 0;
            top: 0;
            overflow: hidden;
        }

        .ol-popup {
            position: absolute;
            background-color: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            min-width: 100px;
            white-space: nowrap;
            display: none;
        }

        .control-container {
            position: absolute;
            top: 65px;
            left: 10px;
            background: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-family: sans-serif;
        }

        .legend-style {
            position: absolute;
            top: 163px;
            left: 10px;
            background-color: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            min-width: 100px;
            z-index: 1000;
            font-family: sans-serif;
            visibility: hidden;
        }
    </style>
</head>

<body>

    <div id="map" class="map"></div>

    <div class="control-container">
        <form id="style-switcher">
            <b>Style</b><br>
            <label><input type="radio" name="style" value="default" checked>None</label>
            <br>
            <label><input type="radio" name="style" value="byspeed">By speed</label>
            <br>
            <label><input type="radio" name="style" value="bydate">By date</label>
        </form>
    </div>

    <div id="speedDiv" class="legend-style">
        <div><svg id="legendSpeedSVG" width="300" height="55"></svg></div>
        <input id="speedRangeMin" type="range" min="0" max="250" step="1" value="0" /><label id="speedRangeMinLbl"
            for="speedRangeMin">Min: 0 km/h</label><br>
        <input id="speedRangeMax" type="range" min="0" max="250" step="1" value="250" /><label id="speedRangeMaxLbl"
            for="speedRangeMax">Max: 250 km/h</label>
    </div>
    <div id="dateDiv" class="legend-style">
        <div><svg id="legendDateSVG" width="300" height="55"></svg></div>
        <input id="dateRangeMin" type="range" min="2008" max="2025" step="1" value="2008" /><label id="dateRangeMinLbl"
            for="dateRangeMin">Min: 2008</label><br>
        <input id="dateRangeMax" type="range" min="2009" max="2026" step="1" value="2026" /><label id="dateRangeMaxLbl"
            for="dateRangeMax">Max: 2026</label>
    </div>

    <div id="popup" class="ol-popup"></div>

    <script>

        //color scales
        const colorScaleSpeed = d3.scaleLinear().domain([0, 0.05, 0.4, 0.75, 0.95, 1]).range(["#4DAF4A", "#4DAF4A", "#377EB8", "#E41A1C", "#FFFF33", "#FFFF33"]);
        const colorScaleDate = d3.scaleLinear().domain([0, 0.5, 1]).range(["#377EB8", "#FFFF33", "#E41A1C"]);

        //legend for date style
        d3.select('#speedDiv').style('visibility', 'hidden')
        const svgSpeed = d3.select('#legendSpeedSVG');
        for (let i = 0; i < 300; i++)
            svgSpeed.append('line')
                .attr('x1', i)
                .attr('y1', 15)
                .attr('x2', i)
                .attr('y2', 15 + 20)
                .attr('stroke', colorScaleSpeed(i / 300))
                .attr('stroke-width', 1);
        svgSpeed.append('text').attr("x", 0).attr("y", 10).text("Slow").style("font-family", "Arial").style("font-size", "12").style("font-weight", "bold")
        svgSpeed.append('text').attr("x", 300).attr("y", 10).text("Fast").style("font-family", "Arial").style("font-size", "12").style("font-weight", "bold").style("text-anchor", "end")
        svgSpeed.append('text').attr("x", 0).attr("y", 50).text("Walk").style("font-family", "Arial").style("font-size", "12")
        svgSpeed.append('text').attr("x", 40).attr("y", 50).text("Run").style("font-family", "Arial").style("font-size", "12")
        svgSpeed.append('text').attr("x", 80).attr("y", 50).text("Bike").style("font-family", "Arial").style("font-size", "12")
        svgSpeed.append('text').attr("x", 180).attr("y", 50).text("Drive").style("font-family", "Arial").style("font-size", "12")
        svgSpeed.append('text').attr("x", 300).attr("y", 50).text("Fly").style("font-family", "Arial").style("font-size", "12").style("text-anchor", "end")

        //legend for date style
        d3.select('#dateDiv').style('visibility', 'hidden')
        const divLgDate = d3.select('#legendDate')
        const svgDate = d3.select('#legendDateSVG');
        for (let i = 0; i < 300; i++)
            svgDate.append('line')
                .attr('x1', i)
                .attr('y1', 15)
                .attr('x2', i)
                .attr('y2', 15 + 20)
                .attr('stroke', colorScaleDate(i / 300))
                .attr('stroke-width', 1);
        svgDate.append('text').attr("x", 0).attr("y", 10).text("Old").style("font-family", "Arial").style("font-size", "12").style("font-weight", "bold")
        svgDate.append('text').attr("x", 300).attr("y", 10).text("New").style("font-family", "Arial").style("font-size", "12").style("font-weight", "bold").style("text-anchor", "end")
        svgDate.append('text').attr("x", 0).attr("y", 50).text("2009").style("font-family", "Arial").style("font-size", "12")
        svgDate.append('text').attr("x", 100).attr("y", 50).text("2015").style("font-family", "Arial").style("font-size", "12").style("text-anchor", "middle")
        svgDate.append('text').attr("x", 200).attr("y", 50).text("2020").style("font-family", "Arial").style("font-size", "12").style("text-anchor", "middle")
        svgDate.append('text').attr("x", 300).attr("y", 50).text("2024").style("font-family", "Arial").style("font-size", "12").style("text-anchor", "end")

        // highlight style
        const highlightStyleLine = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: "red",
                width: 5
            })
        })
        const highlightStylePoint = new ol.style.Style({
            image: new ol.style.Circle({
                radius: 3,
                fill: new ol.style.Fill({ color: '#8400B2' }),
                stroke: new ol.style.Stroke({ color: 'red', width: 1 })
            })
        });


        //const bckgs = new ol.source.OSM()
        //const bckgs = new ol.source.XYZ({ url: 'http://{a-c}.tile.stamen.com/toner/{z}/{x}/{y}.png' });
        const bckgs = new ol.source.XYZ({ url: 'https://{a-d}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png' })

        //build map
        var map = new ol.Map({
            target: 'map',
            layers: [new ol.layer.Tile({ source: bckgs })],
            view: new ol.View({ center: ol.proj.fromLonLat([5.3, 47]), zoom: 6 })
        });


        //default style
        const defaultLineStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({ color: "#8400B2", width: 1 })
        });
        const defaultPointStyle = new ol.style.Style({
            image: new ol.style.Circle({
                radius: 2.5,
                fill: new ol.style.Fill({ color: '#8400B2' }),
                //stroke: new ol.style.Stroke({ color: 'black', width: 1 })
            })
        });
        const styleDefaultFun = function (f) {
            const t = f.getGeometry().getType()
            if (t == "LineString" || t == "MultiLineString") return defaultLineStyle
            else if (t == "Point") return defaultPointStyle
            else console.log(t)
        }

        //speed style
        const styleSpeedFun = function (f) {
            const sp = f.get('speed_kmh')

            //skip depending on speed range
            const minS = document.getElementById("speedRangeMin").value;
            if (sp < minS) return
            const maxS = document.getElementById("speedRangeMax").value;
            if (maxS < 250 && sp > maxS) return

            const t = (sp - 5) / 180
            const color = colorScaleSpeed(t)
            return new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: color,
                    width: 1.5
                })
            });
        }

        //date style
        const styleDateFun = function (f) {
            const ymin = 39.6, ymax = 56
            const timestamp = f.get('start_time')
            const date = new Date(timestamp);
            const years = date.getTime() / 31557600000;
            const t = (years - ymin) / (ymax - ymin)
            const color = colorScaleDate(t)

            //skip depending on year range
            const y = date.getFullYear()
            const minS = document.getElementById("dateRangeMin").value;
            if (y < minS) return
            const maxS = document.getElementById("dateRangeMax").value;
            if (y > maxS) return

            return new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: color,
                    width: 1.5
                })
            });
        }


        //define GPS traces layer
        //const url = "http://127.0.0.1:5500/tiled/"
        const url = "https://raw.githubusercontent.com/jgaffuri/GeoLogMap/main/assets/jg/"
        const vectorSource = getTiledVectorSource(url)
        var vectorLayer = new ol.layer.Vector({ source: vectorSource, style: styleDefaultFun });
        map.addLayer(vectorLayer);



        // popup
        const popupElement = document.getElementById('popup');

        // variable to store the currently highlighted feature
        let highlightedFeatures = null;

        // pointer move event listener
        map.on('pointermove', function (evt) {
            // hide popup element
            popupElement.style.display = 'none';

            // get feature under the mouse cursor
            const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) { return feature; });
            const new_id = feature?.get("identifier")

            //show popup with feature
            if (new_id) {
                popupElement.innerHTML = `Start: ${feature.get('start_time')}<br>End: ${feature.get('end_time')}<br>Length: ${(feature.get('length_m') / 1000).toFixed(1)} km<br>Duration: ${(feature.get('duration_s') / 60).toFixed(1)} min<br>Av speed: ${(feature.get('speed_kmh'))} km/h`;
                popupElement.style.left = `${evt.pixel[0] + 7}px`;
                popupElement.style.top = `${evt.pixel[1] + 7}px`;
                popupElement.style.display = 'block';
            }

            // reset the style of the previously highlighted feature
            if (highlightedFeatures) {
                for (let f of highlightedFeatures) f.setStyle(null);
                highlightedFeatures = null;
            }
            // highlight the feature under the mouse cursor
            if (new_id) {
                highlightedFeatures = []
                for (let f of vectorSource.getFeatures())
                    if (new_id == f.get("identifier")) {
                        highlightedFeatures.push(f)
                        const t = f.getGeometry().getType()
                        if (t == "LineString" || t == "MultiLineString") f.setStyle(highlightStyleLine)
                        else if (t == "Point") f.setStyle(highlightStylePoint)
                        else console.log(t)
                    }
            }

        });




        //radio button change event
        document.getElementById('style-switcher').addEventListener('change', () => {
            //get selected style
            const selectedStyle = document.querySelector('input[name="style"]:checked').value

            //set layer style
            if (selectedStyle == "byspeed") vectorLayer.setStyle(styleSpeedFun)
            else if (selectedStyle == "bydate") vectorLayer.setStyle(styleDateFun)
            else vectorLayer.setStyle(styleDefaultFun)

            //show/hide legends
            d3.select('#speedDiv').style('visibility', selectedStyle == "byspeed" ? 'visible' : 'hidden');
            d3.select('#dateDiv').style('visibility', selectedStyle == "bydate" ? 'visible' : 'hidden');

            //update
            vectorSource.update___()
        });


        //range sliders: speed
        document.getElementById('speedRangeMin').addEventListener('input', updateSpeedRange)
        document.getElementById('speedRangeMax').addEventListener('input', updateSpeedRange)
        function updateSpeedRange() {
            const min = document.getElementById("speedRangeMin").value;
            const max = document.getElementById("speedRangeMax").value;

            document.getElementById("speedRangeMinLbl").innerHTML = "Min: " + min + " km/h";
            document.getElementById("speedRangeMaxLbl").innerHTML = "Max: " + max + " km/h";

            //update
            vectorSource.update___()
        }

        //range sliders: date
        document.getElementById('dateRangeMin').addEventListener('input', updateDateRange)
        document.getElementById('dateRangeMax').addEventListener('input', updateDateRange)
        function updateDateRange() {
            const min = document.getElementById("dateRangeMin").value;
            const max = document.getElementById("dateRangeMax").value;

            document.getElementById("dateRangeMinLbl").innerHTML = "Min: " + min;
            document.getElementById("dateRangeMaxLbl").innerHTML = "Max: " + max;

            //update
            vectorSource.update___()
        }



    </script>
</body>

</html>