<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Vector Tiles Example</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/openlayers/dist/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/openlayers/dist/ol.js"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map" class="map"></div>
    <script>

        fetch('http://127.0.0.1:5500/tiles_100km/metadata.json')
            .then(response => response.json())
            .then(metadata => {

                const ts = metadata.tile_size, ox = metadata.origin_x, oy = metadata.origin_y, r = metadata.resolution

                //build map
                var map = new ol.Map({
                    target: 'map',
                    layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
                    view: new ol.View({ center: ol.proj.fromLonLat([5.3698, 43.2965]), zoom: 12 })
                });

                //create vector layer
                var vectorSource = new ol.source.Vector();
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource,
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#ff0000',
                            width: 2
                        })
                    })
                });
                map.addLayer(vectorLayer);

                //fetch and transform geojson data
                function fetchTile(tile) {
                    const url = `http://127.0.0.1:5500/tiles_100km/${tile.x}/${tile.y}.geojson`
                    return fetch(url)
                        .then(response => response.json())
                        .then(geojson => {
                            //
                            function transformGeoJSONGeometryCoordinates(geometry) {
                                function transformCoordinates(coordinates) {
                                    if (Array.isArray(coordinates[0])) return coordinates.map(transformCoordinates);
                                    else {
                                        const x = coordinates[0], y = coordinates[1]
                                        //console.log(coordinates)
                                        //TODO transform
                                        return [ox + tile.x * ts + x * r, oy + tile.y * ts + y * r];
                                    }
                                }
                                if (geometry && geometry.coordinates)
                                    geometry.coordinates = transformCoordinates(geometry.coordinates);
                            }

                            //apply coordinates transformation to features
                            geojson.features.forEach(feature => {
                                console.log(feature.geometry)
                                transformGeoJSONGeometryCoordinates(feature.geometry)
                                console.log(feature.geometry)
                            });
                            return geojson;
                        });
                }

                function updateLayer() {
                    var bbox = map.getView().calculateExtent(map.getSize());
                    //var bbox = extent //ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');
                    var tiles = generateGeoJSONUrls(bbox);

                    vectorSource.clear();

                    tiles.forEach(tile => {
                        fetchTile(tile)
                            .then(geojson => {
                                var features = new ol.format.GeoJSON().readFeatures(geojson, { featureProjection: 'EPSG:3857' });
                                vectorSource.addFeatures(features);
                            })
                            .catch(error => console.error('Error fetching GeoJSON:', error));
                    });
                }

                function generateGeoJSONUrls(bbox) {
                    const [xmin, ymin, xmax, ymax] = bbox;

                    const
                        xtmin = Math.floor((xmin - metadata.origin_x) / metadata.tile_size),
                        ytmin = Math.floor((ymin - metadata.origin_y) / metadata.tile_size),
                        xtmax = Math.ceil((xmax - metadata.origin_x) / metadata.tile_size),
                        ytmax = Math.ceil((ymax - metadata.origin_y) / metadata.tile_size)

                    var tiles = [];
                    for (var xt = xtmin; xt <= xtmax; xt++) {
                        for (var yt = ytmin; yt <= ytmax; yt++) {
                            //var url = `http://127.0.0.1:5500/tiles_100km/${xt}/${yt}.geojson`
                            tiles.push({ x: xt, y: yt });
                        }
                    }
                    return tiles;
                }

                //trigger layer refresh on viewshed changes
                map.getView().on('change:center', updateLayer);
                map.getView().on('change:resolution', updateLayer);

                updateLayer();

            })
            .catch(error => console.error('Error fetching the JSON data:', error));
    </script>
</body>

</html>